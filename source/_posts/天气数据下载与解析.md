---
title: 天气数据下载与解析
top: false
cover: false
toc: true
mathjax: true
tags:
  - gis
  - python
date: 2024-06-10 23:40:47
password:
summary:
categories:
---

最近在做一个项目，需要搭建一个天气数据服务，考察了诸多天气网站API之后，综合考量选择了使用Herbie数据库进行天气预测数据的下载，顺手记录一下使用Herbie库、pygrib等库进行数据下载、解析的使用方法。
# 如何下载
## Herbie库
### 简介
[Herbie](https://herbie.readthedocs.io/en/stable/)是一个Python软件包，通过该库可以使用简单的几行命令下载最新的和历史的数值天气预报（NWP）模型输出，这些数据来源于不同的云存储档案，NWP数据是以GRIB2格式分发的，可以通过xarray（cfgrib）或者pygrib包读取。Herbie库极大地简化了访问和处理复杂NWP模型数据的过程，使得研究人员和开发者能够更高效地探索和使用这些数据。
### 环境安装和配置
Herbie库支持Xarray访问数据，依赖python3.9+版本，建议使用conda构建一个python3.9的虚拟环境，安装Anaconda的步骤不再赘述。
```python
#构建python3.9虚拟环境， conda版本 4.10.1
conda create --name <your_virtual_env> python=3.9
conda env list
conda activate <your_virtual_env>
conda install -c conda-forge herbie-data
```
Herbie库安装成功后，会生成一个默认的配置文件，位于`~/.config/herbie/config.toml`
内容如下：
```toml
# Herbie defaults

[default]
model = "hrrr"   #使用模型
fxx = 0  #预测时效性
save_dir = "path_to_your_save_dir"  #下载的grib2文件保存路径
overwrite = false  #为false表示如果本地已存在模型文件，则不重复下载
verbose = true  #下载时打印详细信息

# =============================================================================
# You can set the priority order for checking data sources.
# If you don't specify a default priority, Herbie will check each source in the
# order listed in the model template file. Beware: setting a default priority
# might prevent you from checking all available sources.
#
#priority = ['aws', 'nomads', 'google', 'azure', 'etc.']
```

### 数值天气预报模型
通过Herbie可以下载来自不同天气预报模型的数据，目前主要使用过其中三种：
- HRRR高分辨率快速刷新模型：专注于美国本土及其近海区域的短期预报，如果需要全球范围的天气预报数据，就不要考虑该模型了；
- ECMWF欧洲中期天气预报中心模型：精度高，模型数据文件大（超过1GB），下载较慢，更新时效也慢一些；
- GFS全球预报系统模型：由美国国家海洋和大气管理局 (NOAA) 运营，是一个全球范围内的天气预报模型，更新较快，下载也快一些。gfs模型下载的文件名格式形如：`gfs.t06z.pgrb2.0p25.f024`
	- gfs: 表示这是来自GFS模型的数据。
	- .t06z: 表示数据是从UTC（世界协调时间）06:00开始的预报周期。
	- .pgrb2: 表示数据是以GRIB2格式编码的。GRIB（GRIdded Binary，网格二进制）是一种广泛使用的气象数据交换格式，GRIB2是其更新版本。
	- .0p25: 表示数据的空间分辨率是0.25度经纬度网格，也就是约28公里左右的网格间距。
	- .f024: 表示这是从预报周期开始后的第24小时的预报数据。GFS通常会生成长达16天（384小时）的预报。

### 下载最新的数据
Herbie库在请求天气预报模型数据时，默认使用协调世界时（Coordinated Universal Time, UTC）作为时间标准。Herbie中的天气预报模型包含四个预测周期，UTC时间每日的00:00、6:00、12:00、18:00，换算成北京时间需要加上8个小时。
下载最新预测天气数据可以使用如下代码，该代码会自动从最近的预测周期开始查找预测数据。
```python
#以下载预测时效为24小时的gfs模型数据为例，其他模型注意更换参数
H = HerbieLatest(model="gfs", product="pgrb2.0p25", fxx=24)
H.Download(verbose=True)
print(H.Date) #获取预测时间
```
# 如何解析
下载天气数据均为[grib2](https://herbie.readthedocs.io/en/stable/user_guide/background/grib2.html)文件，官方给出了两个解析工具——cfgrib和pygrib。安装命令如下：
```python
conda install -c conda-forge pygrib cfgrib
```
两者都是用于处理GRIB2格式气象数据的Python库，但它们在使用方式、依赖关系和返回数据的形式上有所区别：
## cfgrib
- **依赖关系**：`cfgrib`是`xarray`库的一个依赖，用于直接读取GRIB数据到`xarray.Dataset`对象。这意味着它充分利用了`xarray`强大的多维数据处理能力，适合那些熟悉`xarray`或需要进行高级数据分析的用户。
- **使用方式**：使用`cfgrib`通常通过`xarray.open_dataset()`函数，指定GRIB文件路径或URL，以及引擎为`cfgrib`。例如：
```python
import xarray as xr
with xr.open_dataset(grib2_path, engine='cfgrib',
                     backend_kwargs={'filter_by_keys': {'stepType': 'accum', 'typeOfLevel': 'surface'}}) as ds:
    # 打印所有变量名称
    print("Variables in the GRIB2 file:")
    for var_name in ds.data_vars:
       print(var_name)
    # 打印具体变量的数值和经纬度
    tp = ds['tp'] #tp是变量名，表示总降水量
    print(tp.shape)
    print(tp.values)
    print(tp.latitude.values)
    print(tp.longitude.values)
```
- **返回数据形式**：`cfgrib`返回的是一个`xarray.Dataset`对象，其中包含了多个`xarray.DataArray`。每个`DataArray`对应GRIB文件中的一个变量，包含数据值、坐标（时间和空间维度）以及元数据（如单位、描述等）。这种数据结构非常适合进行数组运算、筛选、切片和复杂的数据分析。
## [pygrib](https://jswhit.github.io/pygrib/api.html)
- **依赖关系**：`pygrib`是一个独立的库，直接基于ECMWF的GRIB API，不需要`xarray`作为基础。它主要用于直接读取和操作GRIB2文件中的数据。
- **使用方式**：使用`pygrib`首先需要打开GRIB文件，然后逐条读取或选择特定的记录。例如：
```python
import pygrib
grbs = pygrib.open('path/to/file.grib2')
for grb in grbs:
    print(grb.name, grb.shortName, grb.typeOfLevel, grb.stepType)
	data, lats, lons = grb.data(), grb.latlons()
grbs.close()
```
- **返回数据形式**：`pygrib`处理单个GRIB记录时，通常会返回数据值（如一个NumPy数组），以及通过单独调用获得的地理坐标信息（如经纬度网格）。这意味着，相比`cfgrib`，它返回的数据形式更基础，需要用户自己处理数据的结构化和后续分析。